<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.6.0/css/bootstrap.min.css">
    
    
    
    <style>

        #div-lab4 {
        background-image: url("https://images.unsplash.com/photo-1580933073521-dc49ac0d4e6a?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxzZWFyY2h8Mnx8Y29mZmVlJTIwYmVhbnN8ZW58MHx8MHx8&w=1000&q=80");
        background-repeat: no-repeat;
        background-size: cover;
        background-position: center;
        width : 100%;
        height: 100%;
        opacity: 0.9;
        position: absolute;
        padding-top: 600px;
        }

        #rcorners3 {
        border-radius: 25px;
        border: 10px double #f5f1ed;
        width: 80%;
        padding: 4px; 
        text-shadow: 5px 5px 10px #1d1d1d;

        background: #dad2bc;
        background-clip: padding-box;
        text-align: center;
        }

        .LucidaConsole {
            font-family: "Lucida Console", "Courier New", monospace;
            color: #ffd8b9;
            text-shadow: 5px 7px #1d1d1d;
            font-size: 40px;
            color:antiquewhite;

            }

        .product {
            border: none !important;
        }

        .product img {
            height: 150px;
            width: auto;
            margin-bottom: -50px;
            margin-left: 1rem;
            transition: 0.5s;
        }
        

        .product:hover img {
            transform: scale(1.05) rotate(-10deg);
        }

        .product .card-title {
            margin-top: 50px;
        }

        .img-in-cart {
            height: 100px;
            width: 100px;
        }

        .overflow-scroll {
            overflow: scroll;
        }

        ul {
            list-style-type: none;
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #a99985;
        }
        
        li {
            float: left;
        }
        
        li a {
            display: block;
            color: white;
            text-align: center;
            padding: 14px 16px;
            text-decoration: none;
        }

        li.active {
            background-color:#693;
        }

        li.active a {
            color:#fff;
        }
        /* Change the link color to #111 (black) on hover */
        li a:hover {
            background-color: #993;
        }
        
        select {
        -webkit-appearance:none;
        -moz-appearance:none;
        -ms-appearance:none;
        appearance:none;
        outline:0;
        box-shadow:none;
        border:0!important;
        background: #533700;
        background-image: none;
        flex: 1;
        padding: 0 .5em;
        color:#fff;
        cursor:pointer;
        font-size: 1em;
        font-family: 'Open Sans', sans-serif;
        }
        select::-ms-expand {
        display: none;
        }
        .select {
        position: relative;
        display: flex;
        width: 10em;
        height: 3em;
        line-height: 3;
        background: #683800;
        overflow: hidden;
        border-radius: .25em;
        }
        .select::after {
        content: '\25BC';
        position: absolute;
        top: 0;
        right: 0;
        padding: 0 1em;
        background: #6d4300;
        cursor:pointer;
        pointer-events:none;
        transition:.25s all ease;
        }
        .select:hover::after {
        color: #ffd8b9;
        }

    </style>
    
    <script type="text/javascript"> 
        function display_c(){
        var refresh=1000; // Refresh rate in milli seconds
        mytime=setTimeout('display_ct()',refresh)
        }
        
        function display_ct() {
        var x = new Date()
        document.getElementById('ct').innerHTML = x;
        display_c();
        }


        function display_ct() {
            var x = new Date()
            var ampm = x.getHours( ) >= 12 ? ' PM' : ' AM';
            hours = x.getHours( ) % 12;
            hours = hours ? hours : 12;
            hours=hours.toString().length==1? 0+hours.toString() : hours;

            var minutes=x.getMinutes().toString()
            minutes=minutes.length==1 ? 0+minutes : minutes;

            var seconds=x.getSeconds().toString()
            seconds=seconds.length==1 ? 0+seconds : seconds;

            var month=(x.getMonth() +1).toString();
            month=month.length==1 ? 0+month : month;

            var dt=x.getDate().toString();
            dt=dt.length==1 ? 0+dt : dt;

            var x1= dt + "/" + month + "/" + x.getFullYear(); 
            x1 = x1 + " - " +  hours + ":" +  minutes + ":" +  seconds + " " + ampm;
            document.getElementById('current_date').innerHTML = x1;
            
        
        // document.getElementById("date_q").innerHTML = date_q;
        display_c();
        
        }



    </script>
    <ul class="nav">
        <li><a href="/">Main</a></li>
    </ul>





</head>

<body onload=display_ct();>
    
    <div id="div-lab4"></div>
    




    <!-- <div class="container-fluid">
        <div class="col-lg-4 col-md-8 col-12 col-auto">
            <div class='input-group mb-2'>
                <div class='input-group-prepend'>
                    <div class='input-group-text'>*Receipt Date :</div>
                </div>
                <input type='text' id='txt_ReceiptDate' name='date' class='form-control' required>
                <button type='button' class="btn btn-default" id='btn_ReceiptDate'>
                    <span class="fa fa-pager"></span>
                </button>
            </div>
        </div>

    </div> -->
    <!-- <div class="container">
        <h4>Cashier id</h4>
        <select id="cashier_id">
        </select>

        <h4 >Date
        </h4>
        <p id="current_date" >
        </p>
    </div> -->

    <div class="container-fluid">
        <div class="row justify-content-center">
            <div class="col-10">
                <div class="">
                    <div class="row">
                        <div class="col-8 border-right min-vh-100">
                            <div class="vh-100 overflow-scroll pr-2">
                                <div class="d-flex justify-content-between align-items-end mt-3 mb-3 position-sticky bg-"
                                    style="top:0;z-index: 10">
                                    <div class="">
                                        <h4 class="text-dark mb-0 LucidaConsole" id="rcorners3" >KhitSi KhitSi KhaPuChiNo</h4>
                                        

                                    </div>

                                    <div class="text-light">
                                        <div class="form-row">
                                            <div class="mr-2 ">
                                                <h4 class="text-light" >Date</h4>
                                                <p  id="current_date" ></p>
                                            </div>

                                            <div class="">
                                                <h4>Cashier id</h4>
                                                
                                                <div class="select">
                                                    <select  id="cashier_id">
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                </div>
                                <div id="products" class="card-columns">

                                </div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="vh-100 overflow-scroll">
                                <div class="d-flex justify-content-between align-items-end mt-3 mb-3">
                                    <div class="">
                                        <h4 class="text-dark mb-0 " id="rcorners3">My Cart</h4>

                                        <small class="text-light text-50">Added Coffee</small>

                                    </div>
                                    <div class="">
                                        <h4>
                                            <span class="item-in-cart-count text-white">0</span>
                                            <i class="fas fa-shopping-cart text-white"></i>
                                        </h4>
                                    </div>
                                </div>

                                <div id="cart">

                                </div>
                                <div class="total position-sticky py-3 bg-light" style="bottom: 0">


                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div>
        <table>
            <tfoot>
                <tr>
                    <form id='form_order' method=POST>
                        {% csrf_token %}
                    </form>
                </tr>
            </tfoot>
        </table>
    </div>

    



    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>


    <script>

        let products = [];

        function toShort(str, max = 50) {

            if (str.length > max) {
                return str.substring(0, max) + "....."
            }

            return str;

        }

        function cartTotal() {

            let count = $(".item-in-cart-cost").length;

            $(".item-in-cart-count").html(count);


            if (count > 0) {
                let totalCost = $(".item-in-cart-cost").toArray().map(el => el.innerHTML).reduce((x, y) => Number(x) + Number(y));
                // console.log(typeof totalCost);
                $.ajax({
                url: '/payment/list',
                type: 'get',
                dataType: 'json',
                success: function (data) {
                    var opt = '';
                    data.payments.forEach(payment => {
                        opt += `<option value="${payment.payment_method}">${payment.payment_method}</option>` 
                    });
                    console.log(opt)
                    $(".total").html(`
                    <div class="d-flex justify-content-between font-weight-bold px-3">
                        <h4>Total</h4>
                        <h4>$ <span class="cart-cost-total">${Number(totalCost).toFixed(2)}</span></h4>
                    </div>
                    <div class="d-flex justify-content-between font-weight-bold px-3">   
                    </div>

                    <div class="modal-footer">
                        <div class="container">
                            <h4>Payment method</h4>
                                <div class="select">
                                    <select  id="payment_method">
                                        ${opt}
                                    </select>
                                </div>
                        </div>
                        <div class="container">
                            <p align="center">
                                <button class="save_order" @click="generateDialog">Save</button> 
                            </p>
                        </div>
                    </div>
                `)
                }
            })
            } else {
                $(".total").html("empty cart")
            }
        }





        $(document).ready(function () {
            $.ajax({
                url: '/cashier/list',
                type: 'get',
                dataType: 'json',
                success: function(data){
                    var opt = '';
                    data.cashiers.forEach(cashier => {
                        opt += `<option value="${cashier.cashier_id}">${cashier.cashier_id}</option>` 
                    });
                    $('#cashier_id').html(`
                        ${opt}
                    `);
                }
            });

            $.ajax({
                url: '/product/list',
                type: 'get',
                dataType: 'json',
                success: function (data) {
                    // toShow(data);
                    console.log(data);
                    data.products.forEach(product => {
                        products.push(product)
                        var choice = ''
                        if (product.stock == 0) {
                            choice = 'hidden'
                        };


                        $("#products").append(`

                    <div class="card product pt-4" ${choice}>
                        <img src="${product.img_desc}" class="card-img-top" alt="">
                        <div class="card-body border rounded">
                            <p class="card-title font-weight-bold text-nowrap overflow-hidden text-primary">
                            ${product.product_name}
                            </p>
                            <small class="text-black-50">
                            ${toShort(product.description, 120)}

                            <br>
                            <strong>stock = ${product.stock}</strong>
                            
                            
                            </small>
                            <div class="d-flex justify-content-between align-items-end mt-3">
                                <span class="font-weight-bold">${product.unit_price}</span>
                                <button class="btn btn-sm btn-outline-primary add-to-cart" data-id="${product.product_id}">
                                Add <i class="fas fa-cart-plus"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    `)
                    })
                }
            })
        })


        $("#search").on("keyup", function () {
            let keyword = $(this).val().toLowerCase();
            // $(".product").filter(function () {
            //
            //     $(this).toggle($(this).text().toLowerCase().indexOf(keyword) > -1);
            //
            // });

            console.log();

            if (keyword.trim().length) {

                let filterProducts = products.filter(product => {
                    if (product.title.toLowerCase().indexOf(keyword) > -1 || product.description.toLowerCase().indexOf(keyword) > -1 || product.price == keyword) {
                        return product;
                    }
                })

                toShow(filterProducts);
            }

        });



        $("#products").delegate(".add-to-cart", "click", function () {
            let currentItemId = $(this).attr("data-id");
            console.log(currentItemId);


            let productInfo = products.filter(el => el.product_id == currentItemId)[0];
            console.log(productInfo)

            if ($(".item-in-cart").toArray().map(el => el.getAttribute("data-id")).includes(currentItemId)) {

                alert("Already Added")

            } else {

                $("#cart").append(`
        <div class="card border-0 item-in-cart" data-id="${productInfo.product_id}">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-end">
                    <img  src="${productInfo.img_desc}" class="img-in-cart" alt="">
                    <button class="btn btn-outline-danger remove-from-cart">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
                <p class="mt-3">
                    ${productInfo.product_name}
                </p>
                <p class="product_id" hidden>
                    ${productInfo.product_id}
                </p>

                <br>
                <strong>stock = ${productInfo.stock}
                    </strong>

                <div class="d-flex justify-content-between align-items-end">
                    <div class="form-row">
                        <button class="btn btn-outline-primary quantity-minus">
                            <i class="fas fa-minus"></i>
                        </button>

                        <input type="number" class="form-control col-md-4 mx-2 quantity" unitPrice="${productInfo.unit_price}" stock="${productInfo.stock}" value="1" min="1" max='${productInfo.stock}'>
                        
                        <button class="btn btn-outline-primary quantity-plus">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    
                    <p class="mb-0">$ <span class="item-in-cart-cost">${(productInfo.unit_price)}</span></p>
                </div>

                <hr>
            </div>
        </div>
        `);

            }

            cartTotal();

        })

        $('.total').delegate(".save_order", "click", function () {
            console.log('work');
            var rows = [];
            var i = 0;
            $("#cart .card-body ").each(function () {

                var product_id = $(this).find('p.product_id').html().trim();
                let quantity = $(this).find('.form-control').val()
                let total_price = $(this).find('.item-in-cart-cost').html()
                rows[i] = {};
                rows[i]['item_no'] = (i+1);
                rows[i]['product_id'] = product_id;
                rows[i]['quantity'] = quantity
                rows[i]['total_price'] = total_price
                i++;


                console.log(product_id, quantity, total_price );
            });
            
            var token = $('[name=csrfmiddlewaretoken]').val();
            var x = new Date()
            var month=(x.getMonth() +1).toString();
            month=month.length==1 ? 0+month : month;
            var dt=x.getDate().toString();
            dt=dt.length==1 ? 0+dt : dt;
            var x1= month + "/" + dt + "/" + x.getFullYear(); 
            

            console.log($('#form_order').serialize());
            console.log(x1);
            
            $.ajax({
                url: '/coffeeshop/ordercreate',
                type: 'post',
                dataType: 'json',
                headers: { "X-CSRFToken": token },
                data: $('#form_order').serialize()+"&date="+x1
                +"&cashier_id="+$('#cashier_id').val().trim() +"&total_order="+$('.cart-cost-total').html()
                + "&lineitem=" + JSON.stringify({'lineitem': rows})+'&order_no='+'',
                success: function (data) {
                    // toShow(data);
                    console.log(data);
                    // data.products.forEach(product => {
                    //     products.push(product)
                    // })
                }
            })
            $.ajax({
                url: '/coffeeshop/billcreate',
                type: 'post',
                dataType: 'json',
                headers: { "X-CSRFToken": token },
                data: $('#form_order').serialize()+"&payment_method="+$('#payment_method').val().trim()+'&order_no='+''+'&bill_no='+'',
                success: function (data) {
                    // toShow(data);
                    console.log(data);
                    // data.products.forEach(product => {
                    //     products.push(product)
                    // })
                }
            })
    
            console.log(rows)
            window.location.reload(); 
            // refreash after save
        });


        $("#cart").delegate(".remove-from-cart", "click", function () {

            $(this).parentsUntil("#cart").remove();
            cartTotal();

        })

        $("#cart").delegate(".quantity-plus", "click", function () {

            let q = $(this).siblings(".quantity").val();
            let p = $(this).siblings(".quantity").attr("unitPrice");
            let s = $(this).siblings(".quantity").attr("stock");
            console.log(typeof s)

            if (q < parseInt(s)) {
                let newQ = Number(q) + 1;
                let newCost = p * newQ;
                // console.log(p);
                $(this).siblings(".quantity").val(newQ);
                $(this).parent().siblings("p").find(".item-in-cart-cost").html(newCost.toFixed(2));
                cartTotal();
            }
        })


        $("#cart").delegate(".quantity-minus", "click", function () {

            let q = $(this).siblings(".quantity").val();
            let p = $(this).siblings(".quantity").attr("unitPrice");
            if ((q > 1)) {

                let newQ = Number(q) - 1;
                let newCost = p * newQ;
                console.log(q);
                console.log(p);
                $(this).siblings(".quantity").val(newQ);
                $(this).parent().siblings("p").find(".item-in-cart-cost").html(newCost.toFixed(2));
                cartTotal();

            }

        })
        2

        $("#cart").delegate(".quantity", "keyup change", function () {

            let q = $(this).val();
            let p = $(this).attr("unitPrice");
            let s = $(this).attr("stock");
            console.log(p)


            if ((q > 1) & (q <= parseInt(s))) {

                let newQ = Number(q);

                let newCost = p * newQ;
                // console.log(p);
                $(this).val(newQ);
                $(this).parent().siblings("p").find(".item-in-cart-cost").html(newCost.toFixed(2));
                cartTotal();

            } else {
                alert("more than one or no more than stock");
                $(this).val().html(parseInt(s));
            }

        })

    </script>

</body>

</html>